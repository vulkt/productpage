<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Website</title>
   
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Your CSS styles here */
    </style>
</head>
<body>
    <!-- Initial Page -->
    <div id="initial-page">
        <div class="body-1178863">
            <div class="main">
                <div class="content">
                    <div class="div">
                        <div class="logo">
                        </div>
                        <div class="title">
                            <div class="welcome-to-access">
                                Welcome to Access
                            </div>
                        </div>
                        <div class="subtitle">
                            <div class="your-secure-gateway-to-powerful-admin-controls">
                                Your secure gateway to powerful admin controls
                            </div>
                        </div>
                    </div>
                    <div class="div-1">
                        <div class="div-2">
                            <div class="div-3">
                                <div class="label">
                                    <div class="admin-key">
                                        Admin Key
                                    </div>
                                </div>
        <div class="admin-key-1">
            <input type="text" id="passwordInput" class="enter-your-secure-admin-key" placeholder="Enter your secure admin key">
        </div>
        
                                <svg id="11:331" class="div-4"></svg>
                            </div>
                        </div>
                        <div class="div-5">
                            <button class="button" onclick="checkPassword()">
                                <svg id="11:334" class="span"></svg>
                                <div class="access-dashboard">
                                    Access Dashboard
                                </div>
                            </button>
                        </div>
                        
                    </div>
                </div>
            </div>
            <div class="footer">
                <div class="div-6">
                    <svg id="11:052" class="svg-2"></svg>
                    <div class="span-1">
                        <div class="secured-by-access">

                            Secured by 
                        </div>
                        </div>
                    </div>
                </div>
                <div class="div-7">
                    <div class="text--2024-access-all-rights-reserved">
                        Â© 2024 Access. All rights reserved.
                    </div>
                </div>
            </div>
        </div>
        
</div>





  

  <!-- Choice Page -->
  <div id="choice-page" >
  

    <div class="body-1176202">
        <div class="main">
            <div class="div-6">
                <div class="div-7">
                    <div class="h3">
                        <div class="total-users">Total Users</div>
                    </div>
                    <div class="p">
                        <div class="text-15-482">15,482</div>
                    </div>
                    <div class="div-8">
                        <svg id="2:121" class="svg-2"></svg>
                        <div class="span-2">
                       
                        </div>
                    </div>
                </div>
                <div class="div-9">
                    <div class="h3-1">
                        <div class="active-stores">Active Stores</div>
                    </div>
                    <div class="p-1">
                        <div class="text-2-847">2,847</div>
                    </div>
                    <div class="div-10">
                        <svg id="2:126" class="svg-3"></svg>
                        <div class="span-3">
                         
                        </div>
                    </div>
                </div>
                <div class="div-11">
                    <div class="h3-2">
                        <div class="total-reports-issued">Total Reports Issued</div>
                    </div>
                    <div class="p-2">
                        <div class="text-1-234">1,234</div>
                    </div>
                    <div class="div-12">
                        <svg id="2:131" class="svg-4"></svg>
                        <div class="span-4">
                            
                        </div>
                    </div>
                </div>
                <div class="div-13">
                    <div class="h3-3">
                        <div class="system-status">System Status</div>
                    </div>
                    <div class="p-3">
                        <div class="text-987">98.7%</div>
                    </div>
                    <div class="div-14">
                        <svg id="2:136" class="svg-5"></svg>
                        <div class="span-5">
                            <div class="all-systems-operational">All systems operational</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="div-15">
                <div class="div-16">
                    <div class="div-17">
                        <div class="h3-4">
                            <div class="quick-actions">Quick Actions</div>
                        </div>
                    </div>
                    <div class="div-18">
                        <button class="a" onclick="goToDownloadPage()" style="color: black;">
                            <img src="assets/svg/report-icon.svg" class="i-2" alt="Reports">
                            <div class="span-6">Reports</div>
                        </button>
                        <button class="a-1" onclick="goToUsersPage()" style="color: black;">
                            <img src="assets/svg/manage-users-icon.svg" class="i-3" alt="Manage Users">
                            <div class="span-7">Manage Users</div>
                        </button>
                        <button class="a-2" onclick="goToManageStoresPage()" style="color: black;">
                            <img src="assets/svg/manage-stores-icon.svg" class="i-4" alt="Manage Stores">
                            <div class="span-8">Manage Stores</div>
                        </button>
                        <button class="a-3" onclick="goToUploadPage()" style="color: black;">
                            <img src="assets/svg/manage-data-icon.svg" class="i-5" alt="Manage Data">
                            <div class="span-9">Manage Data</div>
                        </button>
                    </div>
                </div>

                <div class="div-19">
                    <div class="div-20">
                        <div class="h3-5">
                            <div class="recent-notifications">Recent Notifications</div>
                        </div>
                        <div class="button-2">
                            <div class="view-all"></div>
                        </div>
                    </div>
                    <div class="div-21">
                        <div class="div-22 recent-notification">
                            <svg id="2:513" class="div-23"></svg>
                            <div class="div-24">
                                
                                <div class="p-6">
                                  
                                    <div class="report-container">
                                        <div class="report-name">Report 1</div> <!-- Updated dynamically -->
                                    </div>
                                    <div class="time-container">
                                        <div class="time-ago"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="div-25 recent-notification">
                            <svg id="2:516" class="div-26"></svg>
                            <div class="div-27">
                               
                                <div class="p-9">
                                  
                                    <div class="report-container">
                                        <div class="report-name">Report 2</div> <!-- Updated dynamically -->
                                    </div>
                                    <div class="time-container">
                                        <div class="time-ago"></div>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                        <div class="div-28 recent-notification">
                            <svg id="2:519" class="div-29"></svg>
                            <div class="div-30">
                                <div class="p-10">
                                    <div class="store-update"></div>
                                </div>
                                
                                <div class="p-12">
                                
                                    <div class="report-container">
                                        <div class="report-name">Report 3</div> <!-- Updated dynamically -->
                                    </div>
                                    <div class="time-container">
                                        <div class="time-ago"></div>
                                    </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>
</div>


<!-- Download Page -->
<div id="download-page" class="section" style="display: none;">
    <h2>Download Files</h2>
    <div id="results"></div>
    <button class="back-button" onclick="backToChoice()">
      <span class="arrow">â</span> Back
    </button>
  </div>
  

    <div id="upload-page" style="display: none;">
        <div class="container">
          <h2 class="page-title">Upload Page</h2>
      
          <!-- Drop Area for File Upload -->
          <div id="drop-area" class="drop-area">
            <p>Drag and drop your file here or click to select a file.</p>
          </div>
      
          <!-- Get Current Data Button -->
          <div class="buttons-container">
            <button id="get-data-button" class="action-button" onclick="getCurrentData()">Get Current Data</button>
          </div>
      
          <!-- Upload Results -->
          <div id="upload-results"></div>
      
          <!-- Back Button -->
          <button onclick="backToChoice()" class="action-button back-button">Back</button>
        </div>
      </div>
      
    
    
    

 <!-- Users Page -->
<div id="users-page" style="display: none;">
    <div class="container">
      <!-- Top Bar: Back Button, Search Bar, Add User Button -->
      <div class="top-bar">
        <button class="btn back-btn" onclick="backToChoice()">Back</button>
  
        <div class="search-bar">
          <input 
            type="text" 
            id="user-search" 
            class="form-input" 
            placeholder="Search for users by name" 
            oninput="searchUsers()" 
          />
        </div>
  
        <button class="btn add-user-btn" onclick="goToAddUserPage()">+ Add New User</button>
      </div>
  
      <!-- User Results -->
      <div id="user-results" class="results-list">
        <!-- User list will be dynamically populated here -->
      </div>
    </div>
  </div>
  

<!-- Add User Page -->
<div id="add-user-page" style="display: none;">
    <div class="user-page-wrapper">
      <h3 class="user-page-title">Add New Employee</h3>
  
      <form id="add-user-form" class="user-form">
        <!-- Full Name Input -->
        <div class="user-form-section">
          <label for="nameInput" class="user-form-label">Full Name</label>
          <input type="text" id="nameInput" class="user-form-input" placeholder="First and Last Name" required>
        </div>
  
        <!-- Permissions Section -->
        <div class="user-form-section">
          <h4 class="permissions-title">Access Permissions</h4>
          <div class="user-checkbox-group">
            <label class="user-checkbox-label">
              <input type="checkbox" id="orderCheckbox" class="user-form-checkbox"> Order Reports
            </label>
            <label class="user-checkbox-label">
              <input type="checkbox" id="wrongPriceCheckbox" class="user-form-checkbox"> Wrong Pricing Reports
            </label>
            <label class="user-checkbox-label">
              <input type="checkbox" id="returnCheckbox" class="user-form-checkbox"> Returns Reports
            </label>
            <label class="user-checkbox-label">
              <input type="checkbox" id="expiredCheckbox" class="user-form-checkbox"> Expired Reports
            </label>
            <label class="user-checkbox-label">
              <input type="checkbox" id="nearExpiredCheckbox" class="user-form-checkbox"> Near Expired Reports
            </label>
            <label class="user-checkbox-label">
              <input type="checkbox" id="inventoryCheckbox" class="user-form-checkbox"> Inventory Reports
            </label>
          </div>
        </div>
  
        <!-- Submit and Feedback -->
        <div class="form-actions">
          <button type="button" class="btn-primary" onclick="addNewUser()">Add Employee</button>
          <button type="button" class="btn-secondary" onclick="backToUsers()">Back to Users</button>
        </div>
  
        <p id="error" class="message error-message"></p>
        <p id="success" class="message success-message"></p>
      </form>
    </div>
  </div>
  




    <!-- User Details Page -->
    <div id="user-details-page" style="display:none;">
        <h2>User Details</h2>
        <div id="user-details"></div>
      
    </div>

    <!-- Manage Stores Page -->
<div id="manage-stores-page" style="display:none;">
    <h2>Manage Stores</h2>

    <!-- Add Store button at the top right -->
    <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
        <button class="add-store-button" onclick="addStore()">+ Add Store</button>
    </div>

    <!-- Store cards go here -->
    <div id="stores-list"></div>

    <!-- Back button -->
    <button id="back-button" onclick="backToChoice()">Back</button>

</div>

    <!-- Firebase SDK and Your Script -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.18.0/firebase-app.js';
        import { getFirestore, collection, query, where, getDocs, doc, updateDoc, getDoc, setDoc, deleteDoc, deleteField, addDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/9.18.0/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, listAll, getDownloadURL, deleteObject  } from 'https://www.gstatic.com/firebasejs/9.18.0/firebase-storage.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDnnHjkUGjHMyCqI5MQspJHR-eJbKwvR00",
            authDomain: "past-jordan.firebaseapp.com",
            projectId: "past-jordan",
            storageBucket: "past-jordan.appspot.com",
            messagingSenderId: "541138565069",
            appId: "1:541138565069:web:e1c0971d58149b98c0f684"
        };

        const app = initializeApp(firebaseConfig);
        const firestore = getFirestore(app);
        const storage = getStorage(app);
        const db = getFirestore(app); // Initialize Firestore

        window.firestore = firestore;
        window.storage = storage;

        window.checkPassword = function () {
    const passwordInput = document.getElementById('passwordInput');
    if (!passwordInput) {
        console.error("Error: Password input field not found.");
        return;
    }

    const password = passwordInput.value.trim();
    console.log("Entered Password:", password);

    if (!password) {
        const errorElement = document.getElementById('initial-error');
        if (errorElement) {
            errorElement.innerHTML = 'Please enter a password.';
        } else {
            console.error("Error: 'initial-error' element not found.");
        }
        return;
    }

    const passwordsRef = collection(window.firestore, 'passwords');
    const q = query(passwordsRef, where('__name__', '==', password));

    getDocs(q)
        .then((querySnapshot) => {
            if (querySnapshot.empty) {
                const errorElement = document.getElementById('initial-error');
                if (errorElement) {
                    errorElement.innerHTML = 'Password not found.';
                } else {
                    console.error("Error: 'initial-error' element not found.");
                }
                return;
            }

            const userDoc = querySnapshot.docs[0];
            const userComp = userDoc.data().comp;
            console.log("User logged in with comp:", userComp);

            localStorage.setItem('userComp', userComp);
            localStorage.setItem('userDocId', userDoc.id);

            showPage('choice-page');

          

            console.log("Calling searchUsers()...");
            if (typeof searchUsers === "function") {
                searchUsers();
            } else {
                console.error("Error: searchUsers function not found.");
            }
        })
        .catch((error) => {
            console.error('Error checking password:', error);
            const errorElement = document.getElementById('initial-error');
            if (errorElement) {
                errorElement.innerHTML = 'Error checking password.';
            } else {
                console.error("Error: 'initial-error' element not found.");
            }
        });
};


        document.addEventListener("DOMContentLoaded", function () {
    window.searchUsers = function() {
        console.log("searchUsers function called");

        const searchInput = document.getElementById('user-search');
        if (!searchInput) {
            console.error("Element '#user-search' not found.");
            return;
        }

        const searchTerm = searchInput.value.trim().toLowerCase();
        console.log("Search term:", searchTerm);

        const userComp = localStorage.getItem('userComp');
        console.log("User's 'comp' value from localStorage:", userComp);

        // Ensure Firestore is initialized
        if (!window.firestore) {
            console.error("Firestore is not initialized.");
            return;
        }

        console.log("Fetching users from Firestore...");

        const passwordsRef = collection(window.firestore, 'passwords');
        const q = query(passwordsRef, where('comp', '==', userComp));

        getDocs(q)
            .then((querySnapshot) => {
                console.log("Query snapshot received. Number of documents:", querySnapshot.size);

                const resultsDiv = document.getElementById('user-results');
                if (!resultsDiv) {
                    console.error("Element '#user-results' not found in the DOM.");
                    return;
                }

                resultsDiv.innerHTML = '';

                if (querySnapshot.empty) {
                    console.log("No users found for the given 'comp' value.");
                    resultsDiv.innerHTML = 'No users found with the same comp value.';
                    return;
                }

                let foundUsers = false;

                querySnapshot.forEach((doc) => {
                    const userId = doc.id.toLowerCase();
                    const userName = doc.data().name ? doc.data().name.toLowerCase() : ''; 
                    
                    console.log(`Checking user: ID=${userId}, Name=${userName}`);

                    if (userId.includes(searchTerm) || userName.includes(searchTerm)) {
                        foundUsers = true;
                        console.log(`Match found: ${doc.id}`);

                        const userLink = document.createElement('a');
                        userLink.textContent = `${doc.data().name} (${doc.id})`; 
                        userLink.href = '#';
                        userLink.onclick = () => loadUserDetails(doc.id);

                        const resultItem = document.createElement('div');
                        resultItem.appendChild(userLink);
                        resultsDiv.appendChild(resultItem);
                    }
                });

                if (!foundUsers) {
                    console.log("No matching users found.");
                    resultsDiv.innerHTML = 'No users found.';
                }
            })
            .catch((error) => {
                console.error("Error fetching users:", error);
                const resultsDiv = document.getElementById('user-results');
                if (resultsDiv) {
                    resultsDiv.innerHTML = 'Error fetching users.';
                }
            });
    };
});


        function showPage(pageId) {
            const pages = ['initial-page', 'choice-page', 'download-page', 'upload-page', 'users-page', 'user-details-page', 'add-user-page', 'manage-stores-page'];
            pages.forEach(page => document.getElementById(page).style.display = 'none');
            document.getElementById(pageId).style.display = 'block';
        }


        function updateButtonVisibility(userData) {
            document.getElementById('download-button').style.display = userData.download ? 'inline-block' : 'none';
            document.getElementById('upload-button').style.display = userData.upload ? 'inline-block' : 'none';
            document.getElementById('users-button').style.display = userData.users ? 'inline-block' : 'none';
        }

        window.goToManageStoresPage = function() {
            showPage('manage-stores-page');
            loadStores();
        };

       function loadStores() {
    const userComp = localStorage.getItem('userComp');
    const storesRef = doc(window.firestore, userComp, 'stores'); // Reference to the "stores" document

    getDoc(storesRef)
        .then((docSnapshot) => {
            const storesList = document.getElementById('stores-list');
            storesList.innerHTML = '';

            if (docSnapshot.exists()) {
                const storeData = docSnapshot.data();

                // Iterate over each field in the "stores" document
                for (const [field, value] of Object.entries(storeData)) {
                    const storeDiv = document.createElement('div');
                    storeDiv.className = 'store-item';

                    storeDiv.innerHTML = `
  <div class="store-name">${field}</div>
  <div class="store-value">${value}</div>
  <div class="store-buttons">
    <button class="action-button edit-button" onclick="editStore('${field}', '${value}')">Edit</button>
    <button class="action-button delete-button" onclick="deleteStore('${field}')">Delete</button>
  </div>
`;


                    storesList.appendChild(storeDiv);
                }
            } else {
                storesList.innerHTML = '<p class="no-stores">No stores found.</p>';
            }
        })
        .catch((error) => {
            console.error('Error loading stores:', error);
            const storesList = document.getElementById('stores-list');
            storesList.innerHTML = '<p class="error-message">Error loading stores. Please try again.</p>';
        });
}

window.addStore = function () {
    const userComp = localStorage.getItem('userComp');
    const storesRef = doc(window.firestore, userComp, 'stores');

    
    const fieldValue = prompt("Enter the store name:");
    const fieldName = prompt("Enter the store number:");

    if (fieldName && fieldValue) {
        setDoc(storesRef, { [fieldName]: fieldValue }, { merge: true })
            .then(() => {
                alert("Store added successfully!");
                loadStores();
            })
            .catch((error) => {
                console.error("Error adding store:", error);
                alert("Error adding store. Please try again.");
            });
    } else {
        alert("Store name and value cannot be empty.");
    }
};

window.deleteStore = function (storeId) {
    const userComp = localStorage.getItem('userComp');
    const storeRef = doc(window.firestore, userComp, 'stores');

    const confirmed = confirm(`Are you sure you want to delete the store "${storeId}"?`);
    if (!confirmed) return;

    updateDoc(storeRef, {
        [storeId]: deleteField(),
    })
        .then(() => {
            alert("Store deleted successfully!");
            loadStores();
        })
        .catch((error) => {
            console.error("Error deleting store:", error);
            alert("Error deleting store. Please try again.");
        });
};

window.editStore = function (storeId, currentValue) {
    const newValue = prompt(`Edit value for "${storeId}":`, currentValue);
    if (newValue !== null && newValue.trim() !== "") {
        const userComp = localStorage.getItem('userComp');
        const storeRef = doc(window.firestore, userComp, 'stores');

        setDoc(storeRef, { [storeId]: newValue }, { merge: true })
            .then(() => {
                alert("Store updated successfully!");
                loadStores();
            })
            .catch((error) => {
                console.error("Error updating store:", error);
                alert("Error updating store. Please try again.");
            });
    } else {
        alert("Value cannot be empty.");
    }
};

        window.goToDownloadPage = function() {
            showPage('download-page');
            searchFolder();
        };

        window.goToUploadPage = function () {
  showPage('upload-page');

  const getDataButton = document.getElementById('get-data-button');
  if (getDataButton) {
    getDataButton.style.display = 'inline-block';
  } else {
    console.error('Error: "Get Current Data" button not found in the DOM');
  }

  const userComp = localStorage.getItem('userComp');
  if (userComp) {
    console.log(`Document found. Comp value: ${userComp}`);
  } else {
    console.error('Error: userComp not found in localStorage');
  }

 
};




        window.goToUsersPage = function() {
            showPage('users-page');
            loadUsersPage();
        };

        window.backToChoice = function() {
            showPage('choice-page');
        };

        window.backToUsers = function() {
            showPage('users-page');
            loadUsersPage();
        };

        window.goToAddUserPage = function() {
            showPage('add-user-page');
        };

       // Function to generate a random user ID with 1 to 6 digits
function generateUserId() {
    return Math.floor(Math.random() * 900000) + 100000; // Generates a 6-figure number between 100000 and 999999
}

window.addNewUser = function() {
    const nameInput = document.getElementById('nameInput').value.trim();
    const orderCheckbox = document.getElementById('orderCheckbox').checked;
    const wrongPriceCheckbox = document.getElementById('wrongPriceCheckbox').checked;
    const returnCheckbox = document.getElementById('returnCheckbox').checked;
    const expiredCheckbox = document.getElementById('expiredCheckbox').checked;
    const nearExpiredCheckbox = document.getElementById('nearExpiredCheckbox').checked;
    const inventoryCheckbox = document.getElementById('inventoryCheckbox').checked;

    const userComp = localStorage.getItem('userComp');
    const passwordsCollection = collection(firestore, 'passwords');

    // Generate and validate user ID
    function addUserWithUniqueId() {
        const userId = generateUserId(); // Generate user ID

        const userRef = doc(passwordsCollection, String(userId));

        getDoc(userRef)
            .then((docSnapshot) => {
                if (!docSnapshot.exists()) {
                    // Add the user if ID is unique
                    setDoc(userRef, {
                        userId: userId,
                        name: nameInput,
                        order: orderCheckbox,
                        'wrong-price': wrongPriceCheckbox,
                        return: returnCheckbox,
                        expired: expiredCheckbox,
                        'near-expired': nearExpiredCheckbox,
                        inventory: inventoryCheckbox,
                        comp: userComp,
                    })
                        .then(() => {
                            displayMessage(
                                'success',
                                `User added successfully! User ID: ${userId}`
                            );
                        })
                        .catch((error) => {
                            displayMessage(
                                'error',
                                `Error adding user: ${error.message}`
                            );
                        });
                } else {
                    // Retry if user ID already exists
                    addUserWithUniqueId();
                }
            })
            .catch((error) => {
                displayMessage('error', `Error checking user ID: ${error.message}`);
            });
    }

    // Helper function to display messages
    function displayMessage(type, message) {
        const successElement = document.getElementById('success');
        const errorElement = document.getElementById('error');

        if (type === 'success') {
            successElement.textContent = message;
            successElement.style.display = 'block';
            errorElement.style.display = 'none';
        } else if (type === 'error') {
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            successElement.style.display = 'none';
        }
    }

    // Start the process of adding a user
    addUserWithUniqueId();
};



//--------------------total users---------------



function updateTotalUsersCount() {
    const userComp = localStorage.getItem('userComp');
    if (!userComp) {
        document.querySelector('.text-15-482').textContent = "0";
        return;
    }

    const passwordsRef = collection(window.firestore, 'passwords');
    const q = query(passwordsRef, where('comp', '==', userComp));

    getDocs(q)
        .then((querySnapshot) => {
            const userCount = querySnapshot.size; // Get the number of users
            document.querySelector('.text-15-482').textContent = userCount.toLocaleString(); // Update the UI
        })
        .catch((error) => {
            console.error("Error fetching user count:", error);
            document.querySelector('.text-15-482').textContent = "Error";
        });
}






//---------------------total stores-------------------


function updateActiveStoresCount() {
    const userComp = localStorage.getItem('userComp');
    const storesRef = doc(window.firestore, userComp, 'stores'); // Reference to the "stores" document

    getDoc(storesRef)
        .then((docSnapshot) => {
            const activeStoresCountElement = document.querySelector('.text-2-847');

            if (docSnapshot.exists()) {
                const storeData = docSnapshot.data();

                // Count the number of fields in the stores document
                const activeStoresCount = Object.keys(storeData).length;

                // Update the "Active Stores" count in the HTML
                if (activeStoresCountElement) {
                    activeStoresCountElement.textContent = activeStoresCount.toLocaleString();
                }
            } else {
                if (activeStoresCountElement) {
                    activeStoresCountElement.textContent = '0'; // No stores found
                }
            }
        })
        .catch((error) => {
            console.error('Error counting stores:', error);
            const activeStoresCountElement = document.querySelector('.text-2-847');
            if (activeStoresCountElement) {
                activeStoresCountElement.textContent = '0'; // Error occurred, display 0
            }
        });
}




    document.addEventListener("DOMContentLoaded", function () {
        updateTotalUsersCount();
        updateActiveStoresCount(); // Call the new function
        updateTotalReportsCount(); // Call the function to update the total reports count
    });



    //----------------reports count------------


    function updateTotalReportsCount() {
    const userComp = localStorage.getItem('userComp');
    const storageRef = ref(window.storage, userComp); // Reference to the folder named after 'userComp'

    // Use listAll to list all files and subfolders inside the userComp folder
    listAll(storageRef)
        .then((result) => {
            let fileCount = 0;

            // Iterate over each subfolder inside the 'userComp' folder
            result.prefixes.forEach((folderRef) => {
                // For each subfolder, we list its files
                listAll(folderRef)
                    .then((subfolderResult) => {
                        // Increment the file count for each file found in subfolder
                        fileCount += subfolderResult.items.length;

                        // Update the UI once all files are counted
                        const totalReportsElement = document.querySelector('.text-1-234');
                        if (totalReportsElement) {
                            totalReportsElement.textContent = fileCount.toLocaleString(); // Format the number
                        }
                    })
                    .catch((error) => {
                        console.error('Error listing files in subfolder:', error);
                    });
            });

            // If no subfolders found, check if there are any files in the main folder
            if (result.items.length > 0) {
                fileCount += result.items.length;
                const totalReportsElement = document.querySelector('.text-1-234');
                if (totalReportsElement) {
                    totalReportsElement.textContent = fileCount.toLocaleString();
                }
            }

        })
        .catch((error) => {
            console.error('Error listing files in Firebase Storage:', error);
            const totalReportsElement = document.querySelector('.text-1-234');
            if (totalReportsElement) {
                totalReportsElement.textContent = '0'; // Show 0 in case of error
            }
        });
}


document.addEventListener("DOMContentLoaded", function () {
        updateTotalReportsCount(); // Call the function to update the total reports count
    });



window.loadUserDetails = function(userId) {
    const userRef = doc(firestore, 'passwords', userId);
    getDoc(userRef)
        .then((doc) => {
            if (doc.exists()) {
                const userDetails = document.getElementById('user-details');
                userDetails.innerHTML = `<pre>${JSON.stringify(doc.data(), null, 2)}</pre>`;
                document.getElementById('user-details-page').style.display = 'block';
            } else {
                console.error('No such user!');
            }
        })
        .catch((error) => {
            console.error('Error fetching user details:', error);
        });
};


//---------------------notifcation-------------
function loadRecentReports() {
    const userComp = localStorage.getItem('userComp'); // Get the userComp value
    const storageRef = ref(window.storage, userComp);  // Reference to the userComp folder

    listAll(storageRef)
        .then((result) => {
            let allFiles = [];

            // Get all subfolders recursively
            const subfolderPromises = result.prefixes.map((folderRef) => {
                return listAll(folderRef).then((subfolderResult) => {
                    subfolderResult.items.forEach((fileRef) => {
                        const fileDate = extractDateFromFileName(fileRef.name); // Extract date from filename
                        if (fileDate) {
                            allFiles.push({
                                name: fileRef.name,
                                fullPath: fileRef.fullPath,
                                timeCreated: fileDate,
                            });
                        }
                    });
                }).catch((error) => {
                    console.error('Error listing files in subfolder:', error);
                });
            });

            // Process files in the main folder
            result.items.forEach((fileRef) => {
                const fileDate = extractDateFromFileName(fileRef.name); // Extract date from filename
                if (fileDate) {
                    allFiles.push({
                        name: fileRef.name,
                        fullPath: fileRef.fullPath,
                        timeCreated: fileDate,
                    });
                }
            });

            // Wait for all subfolder promises to complete
            Promise.all(subfolderPromises)
                .then(() => {
                    // Sort files by the extracted timestamp
                    allFiles.sort((a, b) => b.timeCreated - a.timeCreated);

                    // Get the most recent three files
                    const recentFiles = allFiles.slice(0, 3);

                    // Log the recent files to ensure correct data
                    console.log("Recent Files:", recentFiles);

                    // Display the recent files
                    displayRecentFiles(recentFiles);
                })
                .catch((error) => {
                    console.error('Error processing subfolders:', error);
                });
        })
        .catch((error) => {
            console.error('Error loading reports:', error);
        });
}

function displayRecentFiles(files) {
    const notificationDivs = document.querySelectorAll('.div-21 .recent-notification');

    console.log("Displaying Files:", files);

    // Reset content
    notificationDivs.forEach(div => {
        div.querySelector('.report-name').textContent = "No recent report";
        div.querySelector('.time-ago').textContent = "";
    });

    files.forEach((file, index) => {
        if (index < notificationDivs.length) {
            const notificationDiv = notificationDivs[index];
            const timeAgo = calculateTimeAgo(file.timeCreated);

            // Extract filename until the first underscore (_)
            const shortName = file.name.split('_')[0];

            // Select the correct containers
            notificationDiv.querySelector('.report-name').textContent = shortName;
            notificationDiv.querySelector('.time-ago').textContent = timeAgo;
        }
    });
}




function extractDateFromFileName(fileName) {
    // Match the part of the filename that contains the date in yyyy_MM_dd format
    const datePattern = /(\d{4}_\d{2}_\d{2})/;
    const match = fileName.match(datePattern);

    if (match) {
        let dateString = match[0]; // Extract the date string in yyyy_MM_dd format

        // Log the extracted date string for debugging
        console.log(`Extracted date string from file: ${dateString}`);

        // Replace all underscores with dashes
        dateString = dateString.replace(/_/g, '-'); // Replace all underscores with dashes
        // Log the formatted date string for debugging
        console.log(`Formatted date string: ${dateString}`);

        // Manually create a Date object from the date string
        const dateParts = dateString.split('-');
        const date = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]); // Month is zero-indexed

        // Check if the date is valid
        if (isNaN(date.getTime())) {
            console.log(`Invalid Date extracted from file: ${fileName}`);
            return null;
        }

        // Log for debugging
        console.log(`Extracted valid date from file ${fileName}: ${date}`);

        return date;
    }

    // Log if no date was found
    console.log(`No date found in filename: ${fileName}`);

    return null; // Return null if no valid date was found
}

function calculateTimeAgo(time) {
    const diff = new Date() - time;
    const minutes = Math.floor(diff / 60000);
    if (minutes < 60) {
        return `${minutes} minute(s) ago`;
    } else if (minutes < 1440) {
        return `${Math.floor(minutes / 60)} hour(s) ago`;
    } else {
        return `${Math.floor(minutes / 1440)} day(s) ago`;
    }
}





document.addEventListener('DOMContentLoaded', loadRecentReports);






window.generateUniquePassword = function() {
    // Generate a new 6-digit unique password
    const min = 100000;
    const max = 999999;
    return Math.floor(Math.random() * (max - min + 1)) + min;
};

window.showPage = function(pageId) {
    document.querySelectorAll('.section, #initial-page').forEach((section) => {
        section.style.display = 'none';
    });
    document.getElementById(pageId).style.display = 'block';
};

window.updateButtonVisibility = function(userData) {
    const { order, download, upload, users } = userData;
    document.getElementById('download-button').style.display = order ? 'block' : 'none';
    document.getElementById('upload-button').style.display = upload ? 'block' : 'none';
    document.getElementById('users-button').style.display = users ? 'block' : 'none';
};

window.deleteUser = function() {
    const userId = localStorage.getItem('selectedUserId');
    if (!userId) {
        alert('No user selected.');
        return;
    }

    const userRef = doc(firestore, 'passwords', userId);
    deleteDoc(userRef)
        .then(() => {
            alert('User deleted successfully.');
            backToUsers(); // Navigate back to the users page
        })
        .catch((error) => {
            alert(`Error deleting user: ${error.message}`);
            console.error('Error deleting user:', error);
        });
};




window.searchFolder = async function () {
    const userComp = localStorage.getItem('userComp');
    const folderRef = ref(storage, `/${userComp}`);
    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = '';

    console.log(`Searching in folder: ${folderRef.fullPath}`);

    try {
        const folderList = await listAll(folderRef);

        if (folderList.prefixes.length === 0) {
            resultsDiv.innerHTML = `
                <div class="empty-state">
                    <p>No folders found.</p>
                </div>
            `;
            return;
        }

        // Create a container for the folder list
        const folderContainer = document.createElement('div');
        folderContainer.className = 'folder-container';

        folderList.prefixes.forEach((folder) => {
            const folderName = folder.name.split('/').slice(-1)[0];

            const folderCard = document.createElement('div');
            folderCard.className = 'folder-card';

            const folderLink = document.createElement('a');
            folderLink.className = 'folder-link';
            folderLink.href = '#';
            folderLink.onclick = () => loadFiles(folder.name);

            const folderIcon = document.createElement('div');
            folderIcon.className = 'folder-icon';
            folderIcon.innerHTML = 'ð';

            const folderNameText = document.createElement('div');
            folderNameText.className = 'folder-name';
            folderNameText.textContent = folderName;

            const viewButton = document.createElement('button');
            viewButton.className = 'view-button';
            viewButton.innerHTML = 'View Reports â';
            viewButton.onclick = () => loadFiles(folder.name);

            // Assemble the card
            folderLink.appendChild(folderIcon);
            folderLink.appendChild(folderNameText);

            folderCard.appendChild(folderLink);
            folderCard.appendChild(viewButton);

            folderContainer.appendChild(folderCard);
        });

        resultsDiv.appendChild(folderContainer);
    } catch (error) {
        console.error('Error listing folders:', error);
        resultsDiv.innerHTML = `
            <div class="error-state">
                <p>Error loading folders. Please try again.</p>
            </div>
        `;
    }
};

window.loadFiles = function (folderName) {
    console.log(`Loading files from ${folderName}...`);
    // Add functionality here to load files based on the folder name
};

    // Call the searchFolder function when the page is loaded to populate the dashboard
    document.addEventListener('DOMContentLoaded', searchFolder);





window.loadFiles = async function (folderName) {
    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = ''; 

    const userComp = localStorage.getItem('userComp');
    const folderPath = `${userComp}/${folderName}`; // Construct the full path
    const folderRef = ref(storage, folderPath);

    console.log(`Loading files from folder: ${folderPath}`); // Debugging line

    try {
        const fileList = await listAll(folderRef);

        if (fileList.items.length === 0) {
    resultsDiv.innerHTML = `
        <div class="empty-state">
            <p>No files found.</p>
        </div>
    `;
    return;
}


        // Create a container for the file list
        const fileContainer = document.createElement('div');
        fileContainer.className = 'file-container';

        fileList.items.forEach((fileRef) => {
            const fileName = fileRef.name.split('/').slice(-1)[0];

            // Create a file card
            const fileCard = document.createElement('div');
            fileCard.className = 'file-card';

            // File name as a clickable link
            const downloadLink = document.createElement('a');
            downloadLink.className = 'file-link';
            downloadLink.textContent = fileName;
            downloadLink.href = '#';
            downloadLink.onclick = async () => {
                const url = await getDownloadURL(fileRef);
                window.open(url);
            };

            // Delete button
            const deleteButton = document.createElement('button');
            deleteButton.className = 'delete-button';
            deleteButton.textContent = 'Delete';
            deleteButton.onclick = () => deleteFile(fileRef);

            fileCard.appendChild(downloadLink);
            fileCard.appendChild(deleteButton);
            fileContainer.appendChild(fileCard);
        });

        resultsDiv.appendChild(fileContainer);
    } catch (error) {
        console.error('Error loading files:', error);
        resultsDiv.innerHTML = `
            <div class="error-state">
                <p>Error loading files. Please try again.</p>
            </div>
        `;
    }
};

window.deleteFile = async function (fileRef) {
    const confirmed = confirm(`Are you sure you want to delete ${fileRef.name}?`);
    if (!confirmed) return;

    try {
        await deleteObject(fileRef);
        alert(`${fileRef.name} deleted successfully.`);
        loadFiles(fileRef.parent.fullPath); // Reload files after deletion
    } catch (error) {
        console.error('Error deleting file:', error);
        alert('Error deleting file.');
    }
};


function showUploadPage() {
  document.getElementById('upload-page').style.display = 'block';
  document.getElementById('users-page').style.display = 'none';
  document.getElementById('get-data-button').style.display = 'inline-block';
}

// Hide the upload page
function hideUploadPage() {
  document.getElementById('upload-page').style.display = 'none';
  document.getElementById('get-data-button').style.display = 'none';
}

// Navigate back to the choice page
function backToChoice() {
  showPage('choice-page');
}

// Handle file drag and drop
async function handleDrop(event) {
    event.preventDefault();

    const dropArea = document.getElementById('drop-area');
    const uploadResults = document.getElementById('upload-results');

    const folderName = localStorage.getItem('userComp');
    if (!folderName) {
        uploadResults.innerHTML = 'Please enter a folder name';
        return;
    }

    const files = event.dataTransfer.files;
    if (files.length > 0) {
        const file = files[0];

        if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
            const reader = new FileReader();
            reader.onload = async function (e) {
                const data = e.target.result;

                const workbook = XLSX.read(data, { type: 'binary' });

                for (const sheetName of workbook.SheetNames) {
                    const worksheet = workbook.Sheets[sheetName];

                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    let totalRows = jsonData.length - 1; // Exclude the header row
                    let sheetDataList = []; // Collect data in an array to batch

                    let previousBarcode = null; // Keep track of the previous row's barcode

                    // Display the initial countdown
                    uploadResults.innerHTML = `Processing rows... Total rows: ${totalRows}`;

                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (!row || row.length === 0 || !row[0]) continue;

                        const currentBarcode = row[0]; // Current row's barcode (Cell A)
                        if (currentBarcode === previousBarcode) {
                            // Skip the row if the barcode matches the previous one
                            continue;
                        }
                        previousBarcode = currentBarcode; // Update the previousBarcode

                        // Validate document reference path
                        const docRefPath = `${folderName}/${currentBarcode}`;
                        if ((docRefPath.split('/').length % 2) !== 0) {
                            console.warn(`Skipping invalid document reference: ${docRefPath}`);
                            continue;
                        }

                        const sheetData = {
                            barcode: currentBarcode,
                            name: row[1] || '', // Cell B
                            price: row[2] || 0, // Cell C
                            pic: row[3] || '', // Cell D
                        };

                        sheetDataList.push(sheetData);

                        // If batch size reaches 100 (or any number you want), commit the batch
                        if (sheetDataList.length >= 100) {
                            await createDocumentsInBatch(folderName, sheetDataList);
                            totalRows -= sheetDataList.length; // Update rows remaining
                            sheetDataList = []; // Reset the list
                        }

                        // Update the countdown after every row (for real-time feedback)
                        uploadResults.innerHTML = `Rows remaining: ${totalRows}`;
                    }

                    // Commit remaining documents in batch after the loop
                    if (sheetDataList.length > 0) {
                        await createDocumentsInBatch(folderName, sheetDataList);
                        totalRows -= sheetDataList.length; // Update rows remaining
                    }

                    uploadResults.innerHTML += `<br>Sheet ${sheetName} processed successfully!`;
                }

                uploadResults.innerHTML += `<br>File ${file.name} uploaded successfully!`;
            };

            reader.onerror = function (error) {
                uploadResults.innerHTML = `Error reading file: ${error}`;
            };

            reader.readAsBinaryString(file);
        } else {
            uploadResults.innerHTML = 'Please upload an Excel (.xlsx or .xls) file.';
        }
    }
}

// Create a document in Firestore
async function createDocumentsInBatch(folderName, sheetDataList) {
    const batch = writeBatch(db);
    const colRef = collection(db, folderName);

    sheetDataList.forEach((sheetData) => {
        const docRef = doc(colRef, sheetData.barcode); // Use barcode as document ID
        batch.set(docRef, sheetData);
    });

    try {
        await batch.commit();
        console.log("Batch write successful");
    } catch (error) {
        console.error("Error with batch write:", error);
        throw error; // Re-throw the error to handle it elsewhere
    }
}




// Allow file drag over
function handleDragOver(event) {
  event.preventDefault();
  event.dataTransfer.dropEffect = 'copy';
}

// Fetch data and generate Excel
window.getCurrentData = async function getCurrentData() {
  const folderName = localStorage.getItem('userComp');
  if (!folderName) {
    alert('Please enter a folder name');
    return;
  }

  const colRef = collection(db, folderName);
  const querySnapshot = await getDocs(colRef);
  const rows = [["BARCODE", "NAME", "PRICE", "PICTURE"]];

  querySnapshot.forEach((doc) => {
    const data = doc.data();
    rows.push([data.barcode || '', data.name || '', data.price || 0, data.pic || '']);
  });

  const worksheet = XLSX.utils.aoa_to_sheet(rows);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, "Current Data");

  const timestamp = new Date().toISOString().replace(/[-:.]/g, "_");
  const fileName = `Current_Data_${timestamp}.xlsx`;
  XLSX.writeFile(workbook, fileName);

  alert("Excel file created successfully!");
};


// Set up event listeners
window.onload = function () {
  const dropArea = document.getElementById('drop-area');
  if (dropArea) {
    dropArea.addEventListener('dragover', handleDragOver);
    dropArea.addEventListener('drop', handleDrop);
  }
};





    
function loadUsersPage() {
    const userComp = localStorage.getItem('userComp');
    const resultsDiv = document.getElementById('user-results');

    if (!userComp) {
        resultsDiv.innerHTML = 'User not authenticated.';
        return;
    }

    const stringToColor = (str) => {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            hash = str.charCodeAt(i) + ((hash << 5) - hash);
        }
        const hue = Math.abs(hash % 360);
        return `hsl(${hue}, 70%, 30%)`; // text color
    };

    const lightenColor = (hsl) => hsl.replace(/(\d+)%\)$/, '85%)'); // background color

    const getInitials = (name) => {
        const names = name.trim().split(' ');
        if (names.length === 0) return '';
        if (names.length === 1) return names[0][0].toUpperCase();
        return (names[0][0] + names[1][0]).toUpperCase();
    };

    const passwordsRef = collection(window.firestore, 'passwords');
    const q = query(passwordsRef, where('comp', '==', userComp));

    getDocs(q)
        .then((querySnapshot) => {
            resultsDiv.innerHTML = '';

            if (querySnapshot.empty) {
                resultsDiv.innerHTML = 'No users found with the same comp value.';
                return;
            }

            let rowDiv = null;
            let count = 0;

            querySnapshot.forEach((doc) => {
                if (count % 4 === 0) {
                    rowDiv = document.createElement('div');
                    rowDiv.className = 'user-row';
                    resultsDiv.appendChild(rowDiv);
                }

                const userData = doc.data();
                const userId = doc.id;
                const userName = userData.name || 'No name';

                const initials = getInitials(userName);
                const textColor = stringToColor(userName);
                const bgColor = lightenColor(textColor);

                // Avatar
                const avatar = document.createElement('div');
                avatar.className = 'user-avatar';
                avatar.textContent = initials;
                avatar.style.color = textColor;
                avatar.style.backgroundColor = bgColor;

                // User name link
                const userLink = document.createElement('a');
                userLink.className = 'user-link';
                userLink.textContent = `${userName} (${userId})`;
                userLink.href = '#';
                userLink.onclick = () => loadUserDetails(userId);

                // Card wrapper
                const card = document.createElement('div');
                card.className = 'user-card';
                card.appendChild(avatar);
                card.appendChild(userLink);

                // Add card to row
                rowDiv.appendChild(card);
                count++;
            });
        })
        .catch(() => {
            resultsDiv.innerHTML = 'Error fetching users.';
        });
}




    
        function loadUserDetails(docId) {
    localStorage.setItem('selectedUserId', docId);
    showPage('user-details-page');
    fetchUserDetails(docId);
}


function fetchUserDetails(docId) {
    const userDocRef = doc(window.firestore, 'passwords', docId);

    getDoc(userDocRef)
        .then((docSnapshot) => {
            const userDetailsDiv = document.getElementById('user-details');
            userDetailsDiv.innerHTML = ''; // Clear existing content

            if (!docSnapshot.exists()) {
                userDetailsDiv.innerHTML = `
                    <p class="text-red-600 font-semibold">User not found.</p>
                `;
                return;
            }

            const data = docSnapshot.data();

            // Header Section
            const header = document.createElement('div');
            header.className = "mb-6";
            header.innerHTML = `
                <h1 class="text-3xl font-bold text-black mb-2">User Permissions</h1>
                <div class="h-px bg-gray-200 w-full"></div>
            `;
            userDetailsDiv.appendChild(header);

            // Container for permissions
            const container = document.createElement('div');
            container.className = "bg-white rounded-lg shadow-sm border border-gray-100 p-6 mb-6";

            const title = document.createElement('h2');
            title.className = "text-xl font-semibold mb-6";
            title.textContent = "User Access Permissions";

            const description = document.createElement('p');
            description.className = "text-gray-600 mb-6";
            description.textContent = "Select which features this user can access in the system.";

            container.appendChild(title);
            container.appendChild(description);

            const permissionsWrapper = document.createElement('div');
            permissionsWrapper.className = "space-y-4";

            Object.keys(data).forEach((field) => {
                if (typeof data[field] === 'boolean') {
                    // Row for each permission
                    const row = document.createElement('div');
                    row.className = "permission-row flex items-center p-3 rounded hover:bg-gray-100";

                    // Checkbox
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = data[field];
                    checkbox.className = 'custom-checkbox mr-4';
                    checkbox.onchange = () => updateUserField(docId, field, checkbox.checked);

                    // Label
                    const label = document.createElement('label');
                    label.textContent = field.replace(/_/g, ' '); // Make it look cleaner
                    label.className = "text-lg cursor-pointer flex-1";

                    // Icon placeholder
                    const icon = document.createElement('div');
                    icon.className = "w-8 h-8 flex items-center justify-center text-gray-500";
                    icon.innerHTML = `<i class="ri-shield-user-line"></i>`;

                    row.appendChild(checkbox);
                    row.appendChild(label);
                    row.appendChild(icon);
                    permissionsWrapper.appendChild(row);
                }
            });

            container.appendChild(permissionsWrapper);
            userDetailsDiv.appendChild(container);

            // Buttons section
            const buttonContainer = document.createElement('div');
            buttonContainer.className = "flex justify-between mt-6";

            const backButton = document.createElement('button');
            backButton.className = "bg-gray-100 text-gray-700 px-6 py-3 rounded-button font-medium hover:bg-gray-200 transition-colors whitespace-nowrap flex items-center";
            backButton.innerHTML = `<span class="w-5 h-5 flex items-center justify-center mr-2"><i class="ri-arrow-left-line"></i></span> Back`;
            backButton.onclick = backToUsers;

            const deleteButton = document.createElement('button');
            deleteButton.className = "bg-red-600 text-white px-6 py-3 rounded-button font-medium hover:bg-red-700 transition-colors whitespace-nowrap flex items-center";
            deleteButton.innerHTML = `<span class="w-5 h-5 flex items-center justify-center mr-2"><i class="ri-delete-bin-line"></i></span> Delete User`;
            deleteButton.onclick = deleteUser;

            buttonContainer.appendChild(backButton);
            buttonContainer.appendChild(deleteButton);

            userDetailsDiv.appendChild(buttonContainer);
        })
        .catch((error) => {
            document.getElementById('user-details').innerHTML = `
                <p class="text-red-600 font-semibold">Error loading user details.</p>
            `;
        });
}


        //------------------------------ EXPERMENT----------------
    
        function updateUserField(docId, fieldName, newValue) {
            const userDocRef = doc(window.firestore, 'passwords', docId);
    
            updateDoc(userDocRef, { [fieldName]: newValue })
                .then(() => {
                    console.log(`Updated ${fieldName} to ${newValue}`);
                })
                .catch((error) => {
                    console.error('Error updating user:', error);
                });
        }
    
        window.allowDrop = function(event) {
            event.preventDefault();
        };

       
    
        window.handleDrop = handleDrop;
    

    </script>
   

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.1/xlsx.full.min.js"></script>
   

</body>
</html>
