<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Website</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Your CSS styles here */
    </style>
</head>
<body>
    <!-- Initial Page -->
    <div id="initial-page">
        <input type="text" id="passwordInput" placeholder="Enter password">
        <button onclick="checkPassword()">Submit</button>
        <p id="initial-error"></p>
    </div>

    <!-- Choice Page -->
    <div id="choice-page" style="display: none;">
        <button id="download-button" onclick="goToDownloadPage()">Download</button>
        <button id="upload-button" onclick="goToUploadPage()">Upload</button>
        <button id="users-button" onclick="goToUsersPage()">Users</button>
    </div>

    <!-- Download Page -->
    <div id="download-page" class="section" style="display: none;">
        <h2>Download Files</h2>
        <div id="results"></div>
        <button onclick="backToChoice()">Back</button>
    </div>

    <!-- Upload Page -->
    <div id="upload-page" style="display: none;">
        <div id="drop-area" style="border: 2px dashed black; padding: 20px;">Drop files here</div>
        <div id="upload-results"></div>
        <button onclick="backToChoice()">Back</button>
    </div>

    <!-- User Page -->
    <div id="users-page">
        <h2>Users Page</h2>
        <input type="text" id="user-search" placeholder="Search for users" oninput="searchUsers()" />
        <div id="user-results"></div>
        <button onclick="backToChoice()">Back</button>
        <button onclick="goToAddUserPage()">Add New User</button>
    </div>

    <!-- Add User Page -->
   <!-- Add User Page -->
<div id="add-user-page" style="display:none;">
    <h3>Add New User</h3>
    <form id="add-user-form">
        <label for="nameInput">Enter Name:</label>
        <input type="text" id="nameInput" required><br>
    
        <label for="passwordInputNewUser">Password will be auto-generated:</label>
        <input type="text" id="passwordInputNewUser" disabled><br>
    
        <label for="compInput">Enter Comp:</label> <!-- Add missing comp input -->
        <input type="text" id="compInput" required><br>

        <label for="orderCheckbox">Order:</label>
        <input type="checkbox" id="orderCheckbox"><br>

        <label for="downloadCheckbox">Download:</label>
        <input type="checkbox" id="downloadCheckbox"><br>

        <label for="uploadCheckbox">Upload:</label>
        <input type="checkbox" id="uploadCheckbox"><br>

        <label for="usersCheckbox">Users:</label>
        <input type="checkbox" id="usersCheckbox"><br>

        <button type="button" onclick="addNewUser()">Create User</button>
    </form>
    <p id="error" style="color:red;"></p> <!-- Added for error message -->
    <p id="success" style="color:green;"></p> <!-- Added for success message -->
    <button onclick="backToUsers()">Back to Users</button>
</div>


    <!-- User Details Page -->
    <div id="user-details-page" style="display:none;">
        <h2>User Details</h2>
        <div id="user-details"></div>
        <button onclick="backToUsers()">Back to Users</button>
        <button onclick="deleteUser()">Delete User</button>

      
    </div>
    <!-- Firebase SDK and Your Script -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.18.0/firebase-app.js';
        import { getFirestore, collection, query, where, getDocs, doc, updateDoc, getDoc, setDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.18.0/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, listAll, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.18.0/firebase-storage.js';
    
        const firebaseConfig = {
            apiKey: "AIzaSyDnnHjkUGjHMyCqI5MQspJHR-eJbKwvR00",
            authDomain: "past-jordan.firebaseapp.com",
            projectId: "past-jordan",
            storageBucket: "past-jordan.appspot.com",
            messagingSenderId: "541138565069",
            appId: "1:541138565069:web:e1c0971d58149b98c0f684"
        };
    
        const app = initializeApp(firebaseConfig);
        const firestore = getFirestore(app);
        const storage = getStorage(app);
    
        window.firestore = firestore;
        window.storage = storage;
    
        window.checkPassword = function() {
    const password = document.getElementById('passwordInput').value.trim();
    console.log("Password:", password);  // Log the value of password
    if (!password) {
        document.getElementById('initial-error').innerHTML = 'Please enter a password.';
        return;
    }

    const passwordsRef = collection(window.firestore, 'passwords');
    const q = query(passwordsRef, where('__name__', '==', password));

    getDocs(q)
        .then((querySnapshot) => {
            if (querySnapshot.empty) {
                document.getElementById('initial-error').innerHTML = 'Password not found.';
                return;
            }

            const userDoc = querySnapshot.docs[0];
            const userComp = userDoc.data().comp;

            localStorage.setItem('userComp', userComp);
            localStorage.setItem('userDocId', userDoc.id);

            showPage('choice-page');
            updateButtonVisibility(userDoc.data());
        })
        .catch((error) => {
            console.error('Error checking password:', error);
            document.getElementById('initial-error').innerHTML = 'Error checking password.';
        });
};

    
        // Updated searchUsers to search both 'comp' and 'name' fields
        window.searchUsers = function() {
    const searchTerm = document.getElementById('user-search').value.trim().toLowerCase();
    const userComp = localStorage.getItem('userComp');
    const passwordsRef = collection(window.firestore, 'passwords');
    const q = query(passwordsRef, where('comp', '==', userComp)); // Assuming we filter by comp first

    getDocs(q)
        .then((querySnapshot) => {
            const resultsDiv = document.getElementById('user-results');
            resultsDiv.innerHTML = '';

            if (querySnapshot.empty) {
                resultsDiv.innerHTML = 'No users found with the same comp value.';
                return;
            }

            // Filter users based on the search term for both document ID and name field
            querySnapshot.forEach((doc) => {
                const userId = doc.id.toLowerCase();
                const userName = doc.data().name ? doc.data().name.toLowerCase() : ''; // Handling potential undefined name
                
                if (userId.includes(searchTerm) || userName.includes(searchTerm)) {
                    const userLink = document.createElement('a');
                    userLink.textContent = `${doc.data().name} (${doc.id})`; // Display name and user ID
                    userLink.href = '#';
                    userLink.onclick = () => loadUserDetails(doc.id);

                    const resultItem = document.createElement('div');
                    resultItem.appendChild(userLink);
                    resultsDiv.appendChild(resultItem);
                }
            });

            // If no users match the search term
            if (resultsDiv.innerHTML === '') {
                resultsDiv.innerHTML = 'No users found.';
            }
        })
        .catch((error) => {
            document.getElementById('user-results').innerHTML = 'Error fetching users.';
        });
};


    // Function to navigate to the "Add New User" page
  
    
function showPage(pageId) {
        const pages = ['initial-page', 'choice-page', 'download-page', 'upload-page', 'users-page', 'user-details-page', 'add-user-page'];
        pages.forEach(page => document.getElementById(page).style.display = 'none');
        document.getElementById(pageId).style.display = 'block';
    }

    
        function updateButtonVisibility(userData) {
            document.getElementById('download-button').style.display = userData.download ? 'inline-block' : 'none';
            document.getElementById('upload-button').style.display = userData.upload ? 'inline-block' : 'none';
            document.getElementById('users-button').style.display = userData.users ? 'inline-block' : 'none';
        }
    
        window.goToDownloadPage = function() {
         showPage('download-page');
            searchFolder();
        };
    
        window.goToUploadPage = function() {
            showPage('upload-page');
        };
    
        window.goToUsersPage = function() {
            showPage('users-page');
            loadUsersPage();
        };
    
        window.backToChoice = function() {
            showPage('choice-page');
        };

        window.backToUsers = function() {
    showPage('users-page');
    loadUsersPage(); // Reload the users list after adding
};


        window.goToAddUserPage = function() {
            showPage('add-user-page');
        };

        window.addNewUser = function() {
    const nameInput = document.getElementById('nameInput').value.trim();
    const comp = localStorage.getItem('userComp'); // Use logged-in user's comp
    const order = document.getElementById('orderCheckbox').checked;
    const download = document.getElementById('downloadCheckbox').checked;
    const upload = document.getElementById('uploadCheckbox').checked;
    const users = document.getElementById('usersCheckbox').checked;

    if (!nameInput) {
        document.getElementById('error').innerHTML = 'Please enter a name.';
        return;
    }

    const newPassword = generateUniquePassword(); // Generate a 6-digit password

    const newUserRef = doc(window.firestore, 'passwords', newPassword.toString());
setDoc(newUserRef, {
    name: nameInput,
    comp: comp, // Automatically use current user's comp
    order: order,
    download: download,
    upload: upload,
    users: users
})
.then(() => {
    document.getElementById('success').innerHTML = `User added successfully. Generated password: ${newPassword}`;
})
.catch((error) => {
    document.getElementById('error').innerHTML = 'Error adding user.';
    console.error('Error adding user:', error);
});
};

    

        window.loadUserDetails = function(userId) {
            const userRef = doc(window.firestore, 'passwords', userId);

            getDoc(userRef)
                .then((docSnap) => {
                    if (docSnap.exists()) {
                        const userData = docSnap.data();
                        document.getElementById('user-details').innerHTML = `
                            <p><strong>Name:</strong> ${userData.name}</p>
                            <p><strong>Order:</strong> ${userData.order}</p>
                            <p><strong>Download:</strong> ${userData.download}</p>
                            <p><strong>Upload:</strong> ${userData.upload}</p>
                            <p><strong>Users:</strong> ${userData.users}</p>
                        `;
                        showPage('user-details-page');
                    } else {
                        document.getElementById('user-details').innerHTML = 'User not found.';
                    }
                })
                .catch((error) => {
                    document.getElementById('user-details').innerHTML = 'Error fetching user details.';
                });
        };

        window.generateUniquePassword = function() {
            // Generate a new 6-digit unique password
            const min = 100000;
            const max = 999999;
            return Math.floor(Math.random() * (max - min + 1)) + min;
        };

        window.showPage = function(pageId) {
            document.querySelectorAll('.section, #initial-page').forEach((section) => {
                section.style.display = 'none';
            });
            document.getElementById(pageId).style.display = 'block';
        };

        window.updateButtonVisibility = function(userData) {
            const { order, download, upload, users } = userData;
            document.getElementById('download-button').style.display = download ? 'block' : 'none';
            document.getElementById('upload-button').style.display = upload ? 'block' : 'none';
            document.getElementById('users-button').style.display = users ? 'block' : 'none';
        };

        window.deleteUser = function() {
    const userId = localStorage.getItem('selectedUserId');
    if (!userId) {
        alert('No user selected.');
        return;
    }

    const userRef = doc(window.firestore, 'passwords', userId);
    deleteDoc(userRef)
        .then(() => {
            alert('User deleted successfully.');
            backToUsers(); // Navigate back to the users page
        })
        .catch((error) => {
            alert('Error deleting user: ' + error.message);
            console.error('Error deleting user:', error);
        });
};
    
        function searchFolder() {
    const folderName = localStorage.getItem('userComp');
    if (!folderName) {
        document.getElementById('results').innerHTML = 'Folder name is required.';
        return;
    }

    const storageRef = ref(window.storage, folderName);
    listAll(storageRef)
        .then((res) => {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            if (res.items.length === 0) {
                resultsDiv.innerHTML = 'No files found in this folder.';
                return;
            }

            res.items.forEach((itemRef) => {
                getDownloadURL(itemRef).then((url) => {
                    const fileLink = document.createElement('a');
                    fileLink.href = url;
                    fileLink.textContent = itemRef.name;
                    fileLink.download = itemRef.name;

                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.style.marginLeft = '10px';
                    deleteButton.onclick = () => deleteFile(itemRef);

                    const resultItem = document.createElement('div');
                    resultItem.appendChild(fileLink);
                    resultItem.appendChild(deleteButton);
                    resultsDiv.appendChild(resultItem);
                });
            });
        })
        .catch((error) => {
            document.getElementById('results').innerHTML = 'Error fetching folder contents: ' + error.message;
        });
}



// Function to handle file deletion
function deleteFile(itemRef) {
    deleteObject(itemRef)
        .then(() => {
            alert('File deleted successfully.');
            searchFolder(); // Refresh the folder contents after deletion
        })
        .catch((error) => {
            alert('Error deleting file: ' + error.message);
        });
}

    
    
function handleDrop(event) {
            event.preventDefault();
            const folderName = localStorage.getItem('userComp');
    
            if (!folderName) {
                document.getElementById('upload-results').innerHTML = 'Please enter a folder name.';
                return;
            }
    
            const files = event.dataTransfer.files;
            const resultsDiv = document.getElementById('upload-results');
            resultsDiv.innerHTML = '';
    
            if (files.length === 0) {
                resultsDiv.innerHTML = 'No files were dropped.';
                return;
            }
    
            for (let file of files) {
                const storageRef = ref(window.storage, `new data (${folderName})/${file.name}`);
    
                uploadBytes(storageRef, file).then(() => {
                    console.log(`Uploaded file: ${file.name}`);
                    resultsDiv.innerHTML += `<p>Uploaded file: ${file.name}</p>`;
                }).catch((error) => {
                    console.error('Error uploading file:', error);
                    resultsDiv.innerHTML += `<p>Error uploading file: ${file.name}</p>`;
                });
            }
        }
    
    
        function loadUsersPage() {
            const userComp = localStorage.getItem('userComp');
            if (!userComp) {
                document.getElementById('user-results').innerHTML = 'User not authenticated.';
                return;
            }
    
            const passwordsRef = collection(window.firestore, 'passwords');
            const q = query(passwordsRef, where('comp', '==', userComp));
    
            getDocs(q)
                .then((querySnapshot) => {
                    const resultsDiv = document.getElementById('user-results');
                    resultsDiv.innerHTML = '';
    
                    if (querySnapshot.empty) {
                        resultsDiv.innerHTML = 'No users found with the same comp value.';
                        return;
                    }
    
                    querySnapshot.forEach((doc) => {
                        const userLink = document.createElement('a');
                        userLink.textContent = doc.id;
                        userLink.href = '#';
                        userLink.onclick = () => loadUserDetails(doc.id);
    
                        const resultItem = document.createElement('div');
                        resultItem.appendChild(userLink);
                        resultsDiv.appendChild(resultItem);
                    });
                })
                .catch((error) => {
                    document.getElementById('user-results').innerHTML = 'Error fetching users.';
                });
        }
    
        function loadUserDetails(docId) {
    localStorage.setItem('selectedUserId', docId);
    showPage('user-details-page');
    fetchUserDetails(docId);
}


        function fetchUserDetails(docId) {
            const userDocRef = doc(window.firestore, 'passwords', docId);
    
            getDoc(userDocRef)
                .then((docSnapshot) => {
                    if (!docSnapshot.exists()) {
                        document.getElementById('user-details').innerHTML = 'User not found.';
                        return;
                    }
    
                    const data = docSnapshot.data();
                    const userDetailsDiv = document.getElementById('user-details');
                    userDetailsDiv.innerHTML = '';
    
                    Object.keys(data).forEach((field) => {
                        if (typeof data[field] === 'boolean') {
                            const label = document.createElement('label');
                            label.textContent = `${field}:`;
    
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.checked = data[field];
                            checkbox.onchange = () => updateUserField(docId, field, checkbox.checked);
    
                            userDetailsDiv.appendChild(label);
                            userDetailsDiv.appendChild(checkbox);
                            userDetailsDiv.appendChild(document.createElement('br'));
                        }
                    });
                })
                .catch((error) => {
                    document.getElementById('user-details').innerHTML = 'Error loading user details.';
                });
        }
    
        function updateUserField(docId, fieldName, newValue) {
            const userDocRef = doc(window.firestore, 'passwords', docId);
    
            updateDoc(userDocRef, { [fieldName]: newValue })
                .then(() => {
                    console.log(`Updated ${fieldName} to ${newValue}`);
                })
                .catch((error) => {
                    console.error('Error updating user:', error);
                });
        }
    
        window.allowDrop = function(event) {
            event.preventDefault();
        };
    
        window.handleDrop = handleDrop;
    
    </script>
    
