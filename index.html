<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Website</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Your CSS styles here */
    </style>
</head>
<body>
    <!-- Initial Page -->
    <div id="initial-page">
        <input type="text" id="passwordInput" placeholder="Enter password">
        <button onclick="checkPassword()">Submit</button>
        <p id="initial-error"></p>
    </div>

    <!-- Choice Page -->
    <!-- Choice Page -->
<div id="choice-page" style="display: none;">
    <button id="download-button" onclick="goToDownloadPage()">Download</button>
    <button id="upload-button" onclick="goToUploadPage()">Upload</button>
    <button id="users-button" onclick="goToUsersPage()">Users</button>
</div>


    <!-- Download Page -->
    <div id="download-page" class="section">
        <h2>Download Files</h2>
        <div id="results"></div>
        <button onclick="backToChoice()">Back</button>
    </div>
    
    

    <!-- Upload Page -->
    <div id="upload-page" style="display: none;">
        <div id="drop-area" style="border: 2px dashed black; padding: 20px;">Drop files here</div>
        <div id="upload-results"></div>
        <button onclick="backToChoice()">Back</button>
    </div>

   <!-- Users Page -->
<div id="users-page" style="display: none;">
    <div id="user-results"></div>
    <button onclick="backToChoice()">Back</button>
</div>

    <!-- Firebase SDK and Your Script -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.18.0/firebase-app.js';
        import { getFirestore, collection, query, where, getDocs, doc, updateDoc } from 'https://www.gstatic.com/firebasejs/9.18.0/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, listAll, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.18.0/firebase-storage.js';
    
        const firebaseConfig = {
            apiKey: "AIzaSyDnnHjkUGjHMyCqI5MQspJHR-eJbKwvR00",
            authDomain: "past-jordan.firebaseapp.com",
            projectId: "past-jordan",
            storageBucket: "past-jordan.appspot.com",
            messagingSenderId: "541138565069",
            appId: "1:541138565069:web:e1c0971d58149b98c0f684"
        };

    
        const app = initializeApp(firebaseConfig);
        const firestore = getFirestore(app);
        const storage = getStorage(app);
    
        window.firestore = firestore;
        window.storage = storage;
    
        window.checkPassword = function() {
            const password = document.getElementById('passwordInput').value.trim();
            if (!password) {
                document.getElementById('initial-error').innerHTML = 'Please enter a password.';
                return;
            }
    
            console.log(`Entered password: ${password}`);
    
            const passwordsRef = collection(window.firestore, 'passwords');
            const q = query(passwordsRef, where('__name__', '==', password));
    
            getDocs(q)
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        console.log('Password not found in Firestore.');
                        document.getElementById('initial-error').innerHTML = 'Password not found.';
                        return;
                    }
    
                    const userDoc = querySnapshot.docs[0];
                    const userComp = userDoc.data().comp;
                    console.log(`Document found. Comp value: ${userComp}`);
    
                    localStorage.setItem('userComp', userComp);
                    localStorage.setItem('userDocId', userDoc.id); // Store document ID
                    showPage('choice-page');
                    updateButtonVisibility(userDoc.data()); // Update button visibility based on user's document data
                })
                .catch((error) => {
                    console.error('Error fetching password:', error);
                    document.getElementById('initial-error').innerHTML = 'Error checking password.';
                });
        };
    
        function showPage(pageId) {
            document.getElementById('initial-page').style.display = 'none';
            document.getElementById('choice-page').style.display = 'none';
            document.getElementById('download-page').style.display = 'none';
            document.getElementById('upload-page').style.display = 'none';
            document.getElementById('users-page').style.display = 'none';
            document.getElementById(pageId).style.display = 'block';
        }
    
        window.goToDownloadPage = function() {
    showPage('download-page');
    searchFolder(); // Call searchFolder when navigating to the download page
};
    
        window.goToUploadPage = function() {
            showPage('upload-page');
        };
    
        window.goToUsersPage = function() {
            showPage('users-page');
            loadUsersPage(); // Load users when navigating to the users page
        };
    
        window.backToChoice = function() {
            showPage('choice-page');
        };
    
        function updateButtonVisibility(userData) {
            const downloadVisible = userData.download;
            const uploadVisible = userData.upload;
            const usersVisible = userData.users;
    
            document.getElementById('download-button').style.display = downloadVisible ? 'inline-block' : 'none';
            document.getElementById('upload-button').style.display = uploadVisible ? 'inline-block' : 'none';
            document.getElementById('users-button').style.display = usersVisible ? 'inline-block' : 'none';
        }
    
        function searchFolder() {
    const folderName = localStorage.getItem('userComp');
    if (!folderName) {
        document.getElementById('results').innerHTML = 'Folder name is required.';
        return;
    }

    console.log(`Searching in folder: ${folderName}`); // Log the folder name

    const storageRef = ref(window.storage, folderName);

    listAll(storageRef)
        .then((res) => {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            if (res.items.length === 0) {
                console.log('No files found in this folder.'); // Log if no files are found
                resultsDiv.innerHTML = 'No files found in this folder.';
                return;
            }

            res.items.forEach((itemRef) => {
                getDownloadURL(itemRef).then((url) => {
                    console.log(`Found file: ${itemRef.name}`); // Log each found file
                    const fileName = itemRef.name;

                    // Create download link
                    const fileLink = document.createElement('a');
                    fileLink.href = url;
                    fileLink.textContent = fileName;
                    fileLink.download = fileName;

                    // Create delete button
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.style.marginLeft = '10px';
                    deleteButton.onclick = () => deleteFile(itemRef);

                    // Append link and button to the results
                    const resultItem = document.createElement('div');
                    resultItem.appendChild(fileLink);
                    resultItem.appendChild(deleteButton);
                    resultsDiv.appendChild(resultItem);
                }).catch((error) => {
                    console.error(`Error getting download URL for ${itemRef.name}:`, error);
                });
            });
        })
        .catch((error) => {
            console.error('Error fetching folder contents:', error);
            document.getElementById('results').innerHTML = 'Error fetching folder contents.';
        });
}
function deleteFile(fileRef) {
    fileRef.delete()
        .then(() => {
            console.log(`Deleted file: ${fileRef.name}`);
            // Optionally, you can refresh the file list after deletion
            searchFolder(); // Refresh the list
        })
        .catch((error) => {
            console.error(`Error deleting file: ${fileRef.name}`, error);
            alert(`Error deleting file: ${fileRef.name}`);
        });
}

    
        function handleDrop(event) {
            event.preventDefault();
            const folderName = localStorage.getItem('userComp');
    
            if (!folderName) {
                document.getElementById('upload-results').innerHTML = 'Please enter a folder name.';
                return;
            }
    
            const files = event.dataTransfer.files;
            const resultsDiv = document.getElementById('upload-results');
            resultsDiv.innerHTML = '';
    
            if (files.length === 0) {
                resultsDiv.innerHTML = 'No files were dropped.';
                return;
            }
    
            for (let file of files) {
                const storageRef = ref(window.storage, `new data (${folderName})/${file.name}`);
    
                uploadBytes(storageRef, file).then(() => {
                    console.log(`Uploaded file: ${file.name}`);
                    resultsDiv.innerHTML += `<p>Uploaded file: ${file.name}</p>`;
                }).catch((error) => {
                    console.error('Error uploading file:', error);
                    resultsDiv.innerHTML += `<p>Error uploading file: ${file.name}</p>`;
                });
            }
        }
    
        function loadUsersPage() {
            const userComp = localStorage.getItem('userComp');
    
            if (!userComp) {
                document.getElementById('user-results').innerHTML = 'User not authenticated.';
                return;
            }
    
            const passwordsRef = collection(window.firestore, 'passwords');
            const q = query(passwordsRef, where('comp', '==', userComp));
    
            getDocs(q)
                .then((querySnapshot) => {
                    const resultsDiv = document.getElementById('user-results');
                    resultsDiv.innerHTML = '';
                    if (querySnapshot.empty) {
                        resultsDiv.innerHTML = 'No users found with the same comp value.';
                        return;
                    }
    
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const docId = doc.id;
                        resultsDiv.innerHTML += `
                            <div>
                                <p>Document ID: ${docId}</p>
                                <p>Comp: ${data.comp}</p>
                                <p>
                                    Boolean Fields:
                                    ${Object.keys(data).filter(key => typeof data[key] === 'boolean').map(key => `
                                        <label>
                                            <input type="checkbox" 
                                                data-doc-id="${docId}" 
                                                data-field="${key}" 
                                                ${data[key] ? 'checked' : ''} 
                                                onchange="updateBooleanField(event)">
                                            ${key}
                                        </label>
                                    `).join('<br>')}
                                </p>
                            </div>
                            <hr>
                        `;
                    });
                })
                .catch((error) => {
                    console.error('Error fetching users:', error);
                    document.getElementById('user-results').innerHTML = 'Error fetching users.';
                });
        }
    
        window.updateBooleanField = function(event) {
            const checkbox = event.target;
            const docId = checkbox.getAttribute('data-doc-id');
            const field = checkbox.getAttribute('data-field');
            const value = checkbox.checked;
    
            const docRef = doc(window.firestore, 'passwords', docId);
    
            updateDoc(docRef, { [field]: value })
                .then(() => {
                    console.log(`Updated ${field} to ${value} for document ${docId}`);
                })
                .catch((error) => {
                    console.error(`Error updating ${field} for document ${docId}:`, error);
                });
        };
    
        document.getElementById('drop-area').addEventListener('drop', handleDrop);
        document.getElementById('drop-area').addEventListener('dragover', (event) => event.preventDefault());
    </script>
    
    
    
</body>    
</html>
